<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pediatric BP Percentile (HTML)</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;max-width:980px;margin:18px auto;color:#111}
    h1{font-size:1.4rem}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{border:1px solid #ddd;padding:12px;border-radius:8px;background:#fff}
    label{display:block;font-size:0.9rem;margin-bottom:6px}
    input,select,button{padding:8px;border-radius:6px;border:1px solid #bbb;font-size:0.95rem}
    .small{font-size:0.85rem;color:#444}
    pre{background:#f7f7f7;padding:8px;border-radius:6px;overflow:auto}
    .success{color:green}
  </style>
</head>
<body>
  <h1>Calculadora de percentil de PAS/DBP — versão HTML (client-side)</h1>
  <p class="small">Implementação em HTML + JavaScript. O app tenta baixar as tabelas CDC <em>statage.csv</em> em tempo real; se houver problema de CORS, faça upload manual do CSV (link abaixo) ou cole o L/M/S para a idade desejada.</p>

  <div class="row">
    <div class="card" style="flex:1 1 320px;">
      <h3>Entradas</h3>
      <label>Sexo
        <select id="sex"><option value="1">Masculino</option><option value="2">Feminino</option></select>
      </label>
      <label>Idade (anos, ex: 12.0)
        <input id="age" type="number" step="0.01" value="12.0" min="2" max="20" />
      </label>
      <label>Altura (polegadas)
        <input id="height_in" type="number" step="0.1" value="63.0" />
      </label>
      <label>Pressão (mmHg)
        <input id="bp" type="number" step="0.5" value="120" />
      </label>
      <label>Modelo
        <select id="model">
          <option value="sbp_boys">SBP — Meninos (padrão)</option>
          <option value="sbp_girls">SBP — Meninas</option>
          <option value="dbp_boys">DBP (K5) — Meninos</option>
          <option value="dbp_girls">DBP (K5) — Meninas</option>
        </select>
      </label>

      <details>
        <summary>Coeficientes (editar se necessário)</summary>
        <div class="small">
          <label>Intercept (α) <input id="alpha" type="number" step="0.00001" value="102.19768" /></label>
          <label>β1 <input id="b1" type="number" step="0.00001" value="1.82416" /></label>
          <label>β2 <input id="b2" type="number" step="0.00001" value="0.12776" /></label>
          <label>β3 <input id="b3" type="number" step="0.00001" value="0.00249" /></label>
          <label>β4 <input id="b4" type="number" step="0.00001" value="-0.00135" /></label>
          <label>γ1 <input id="g1" type="number" step="0.00001" value="2.73157" /></label>
          <label>γ2 <input id="g2" type="number" step="0.00001" value="-0.19618" /></label>
          <label>γ3 <input id="g3" type="number" step="0.00001" value="-0.04659" /></label>
          <label>γ4 <input id="g4" type="number" step="0.00001" value="0.00947" /></label>
          <label>σ (desvio padrão) <input id="sigma" type="number" step="0.00001" value="10.7128" /></label>
        </div>
      </details>

      <div style="margin-top:10px">
        <button id="calc">Calcular percentil</button>
        <button id="loadcdc">Baixar CDC statage.csv (recom.)</button>
      </div>

      <hr />
      <label>Ou faça upload do arquivo CDC (statage.csv):
        <input type="file" id="filecsv" accept=".csv" />
      </label>
    </div>

    <div class="card" style="flex:1 1 520px;">
      <h3>Saída</h3>
      <div id="output">
        <p class="small">Clique em "Calcular percentil" para ver o resultado.</p>
      </div>
      <hr />
      <div id="lmssrc" class="small"></div>
    </div>
  </div>

  <hr />
  <p class="small">Fonte: NHLBI Fourth Report Appendix B-1 (coeficientes) e CDC growth charts (stature-for-age L/M/S). Se necessário, solicite que eu pré-processe o CSV para evitar problemas de CORS.</p>

<script>
// Utilities
function parseCSV(text){
  const lines = text.trim().split(/\r?\n/);
  const headers = lines[0].split(',').map(h=>h.replace(/^\uFEFF/,'').trim());
  const rows = lines.slice(1).map(l => {
    // naive split — CDC file should be simple
    const cols = l.split(',').map(c=>c.trim());
    return cols;
  });
  return {headers, rows};
}

function cdfNormal(z){
  // Abramowitz & Stegun approximation via erf
  return 0.5 * (1 + erf(z/Math.SQRT2));
}

function erf(x){
  // numerical approximation of erf (Abramowitz and Stegun 7.1.26)
  const sign = x>=0?1:-1; x = Math.abs(x);
  const a1=  0.254829592;
  const a2=-0.284496736;
  const a3= 1.421413741;
  const a4=-1.453152027;
  const a5= 1.061405429;
  const p= 0.3275911;
  const t = 1.0/(1.0 + p*x);
  const y = 1.0 - (((((a5*t + a4)*t) + a3)*t + a2)*t + a1)*t*Math.exp(-x*x);
  return sign * y;
}

// Global L/M/S storage: keyed by sex (1 or 2), values arrays of {ageMonths, L, M, S}
let LMS = {"1":[], "2":[]};
let csvLoaded = false;

async function loadCDCfromURL(){
  const url = 'https://www.cdc.gov/growthcharts/data/zscore/statage.csv';
  try{
    const r = await fetch(url);
    if(!r.ok) throw new Error('HTTP '+r.status);
    const text = await r.text();
    processStatageCSV(text);
    document.getElementById('lmssrc').innerText = 'statage.csv carregado via URL.';
    csvLoaded = true;
  }catch(err){
    document.getElementById('lmssrc').innerText = 'Não foi possível carregar statage.csv via URL (CORS ou rede). Faça upload do arquivo CSV manualmente.';
    console.warn(err);
  }
}

function processStatageCSV(text){
  const {headers, rows} = parseCSV(text);
  // identify columns: first should be Sex, second Agemos, then L,M,S for stature
  // find column indices
  const h = headers.map(x=>x.toLowerCase());
  let sexIdx = 0; // usually first
  let ageIdx = h.indexOf('agemos')>=0? h.indexOf('agemos') : 1;
  // find first LMS triple after ageIdx
  const L_idx = ageIdx+1; const M_idx = ageIdx+2; const S_idx = ageIdx+3;
  // clear old
  LMS = {"1":[], "2":[]};
  for(const r of rows){
    const sex = r[sexIdx];
    if(!sex) continue;
    const agemos = parseFloat(r[ageIdx]);
    const L = parseFloat(r[L_idx]);
    const M = parseFloat(r[M_idx]);
    const S = parseFloat(r[S_idx]);
    if(isNaN(agemos) || isNaN(L) || isNaN(M) || isNaN(S)) continue;
    if(!LMS[sex]) LMS[sex] = [];
    LMS[sex].push({ageMonths:agemos, L, M, S});
  }
  // sort
  LMS['1'].sort((a,b)=>a.ageMonths-b.ageMonths);
  LMS['2'].sort((a,b)=>a.ageMonths-b.ageMonths);
}

function interpLMS(sex, ageMonths){
  const tab = LMS[String(sex)];
  if(!tab || tab.length===0) return null;
  // if outside range, clamp
  if(ageMonths <= tab[0].ageMonths) return tab[0];
  if(ageMonths >= tab[tab.length-1].ageMonths) return tab[tab.length-1];
  // find bracketing indices
  for(let i=0;i<tab.length-1;i++){
    const a = tab[i], b = tab[i+1];
    if(ageMonths >= a.ageMonths && ageMonths <= b.ageMonths){
      const f = (ageMonths - a.ageMonths)/(b.ageMonths - a.ageMonths);
      return {ageMonths, L: a.L + f*(b.L - a.L), M: a.M + f*(b.M - a.M), S: a.S + f*(b.S - a.S)};
    }
  }
  return null;
}

function computeZht(height_cm, L, M, S){
  if(Math.abs(L) > 1e-8) return (Math.pow(height_cm / M, L) - 1) / (L * S);
  return Math.log(height_cm / M) / S;
}

function setCoefficientsForModel(model){
  // Here you can prefill coefficients for other models. For demo we only set SBP boys default (already set)
  if(model === 'sbp_boys'){
    document.getElementById('alpha').value = '102.19768';
    document.getElementById('b1').value = '1.82416';
    document.getElementById('b2').value = '0.12776';
    document.getElementById('b3').value = '0.00249';
    document.getElementById('b4').value = '-0.00135';
    document.getElementById('g1').value = '2.73157';
    document.getElementById('g2').value = '-0.19618';
    document.getElementById('g3').value = '-0.04659';
    document.getElementById('g4').value = '0.00947';
    document.getElementById('sigma').value = '10.7128';
  }
  // you can add other presets if you paste their coefficients here
}

// Event listeners
document.getElementById('model').addEventListener('change', (e)=> setCoefficientsForModel(e.target.value));

document.getElementById('loadcdc').addEventListener('click', ()=>{
  loadCDCfromURL();
});

document.getElementById('filecsv').addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = function(e){ processStatageCSV(e.target.result); csvLoaded=true; document.getElementById('lmssrc').innerText = 'statage.csv carregado por upload.'; };
  reader.readAsText(f);
});

document.getElementById('calc').addEventListener('click', ()=>{
  const sex = document.getElementById('sex').value;
  const age = parseFloat(document.getElementById('age').value);
  const ageMonths = age * 12.0;
  const height_in = parseFloat(document.getElementById('height_in').value);
  const height_cm = height_in * 2.54;
  const bp = parseFloat(document.getElementById('bp').value);

  // coefficients
  const alpha = parseFloat(document.getElementById('alpha').value);
  const b1 = parseFloat(document.getElementById('b1').value);
  const b2 = parseFloat(document.getElementById('b2').value);
  const b3 = parseFloat(document.getElementById('b3').value);
  const b4 = parseFloat(document.getElementById('b4').value);
  const g1 = parseFloat(document.getElementById('g1').value);
  const g2 = parseFloat(document.getElementById('g2').value);
  const g3 = parseFloat(document.getElementById('g3').value);
  const g4 = parseFloat(document.getElementById('g4').value);
  const sigma = parseFloat(document.getElementById('sigma').value);

  // get LMS
  const lms = interpLMS(sex, ageMonths);
  const out = document.getElementById('output');
  out.innerHTML = '';
  if(!lms){
    out.innerHTML = '<p style="color:crimson">Dados L/M/S não disponíveis. Carregue o statage.csv (botão) ou faça upload manual.</p>';
    return;
  }
  const Zht = computeZht(height_cm, lms.L, lms.M, lms.S);

  const y = age;
  const t = (y - 10.0);
  const mu = alpha + b1*t + b2*(t*t) + b3*(t*t*t) + b4*(t*t*t*t)
            + g1*Zht + g2*(Zht*Zht) + g3*(Zht*Zht*Zht) + g4*(Zht*Zht*Zht*Zht);
  const Zbp = (bp - mu) / sigma;
  const perc = cdfNormal(Zbp) * 100.0;

  out.innerHTML += `<p><strong>Idade (meses):</strong> ${ageMonths.toFixed(2)}</p>`;
  out.innerHTML += `<p><strong>L=${lms.L.toFixed(6)}, M=${lms.M.toFixed(6)}, S=${lms.S.toFixed(6)}</strong></p>`;
  out.innerHTML += `<p><strong>Altura (cm):</strong> ${height_cm.toFixed(2)} — <strong>Z de altura (Zht):</strong> ${Zht.toFixed(4)}</p>`;
  out.innerHTML += `<p><strong>Valor esperado µ:</strong> ${mu.toFixed(2)} mmHg</p>`;
  out.innerHTML += `<p><strong>Z-score da pressão:</strong> ${Zbp.toFixed(3)}</p>`;
  out.innerHTML += `<p class="success"><strong>Percentil estimado:</strong> ${perc.toFixed(1)}th percentile</p>`;

});

// Try to load CDC on page load (non-blocking)
loadCDCfromURL();
</script>
</body>
</html>
